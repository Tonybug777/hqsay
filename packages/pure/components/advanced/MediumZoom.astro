---
// MediumZoom.astro
import config from 'virtual:config';

interface Props {
  selector?: string;
  background?: string;
}

const { 
  selector = config.integ.mediumZoom.selector, 
  background = 'hsl(var(--background) / 0.8)' 
} = Astro.props;

// 准备要传递给客户端的配置对象
const clientConfig = {
  selector,
  background
};
---

<!-- 将配置信息隐藏在HTML中，以便客户端脚本读取 -->
<div id="medium-zoom-config" data-config={JSON.stringify(clientConfig)} hidden></div>

<script>
  import mediumZoom from 'medium-zoom';

  document.addEventListener('DOMContentLoaded', () => {
    // 从隐藏的 div 中读取配置
    const configElement = document.getElementById('medium-zoom-config');
    if (!configElement) return;

    const { selector, background } = JSON.parse(configElement.dataset.config || '{}');

    if (!selector) {
      console.error('MediumZoom: Selector is required but not provided.');
      return;
    }

    // 查找要应用缩放的元素
    const elements = document.querySelectorAll(selector);
    if (elements.length === 0) {
      console.warn(`MediumZoom: No elements found for selector "${selector}".`);
      return;
    }

    // 将 null 转为 undefined，符合 medium-zoom 类型要求
    const bg = background || undefined;
    const options = bg ? { background: bg } : {};

    // 对找到的元素初始化 medium-zoom
    // 注意: medium-zoom 通常只需要调用一次，传入所有匹配的元素
    mediumZoom(elements, options);
  });
</script>

<style is:global>
  .medium-zoom-overlay {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    opacity: 0;
    transition: opacity 0.3s;
    will-change: opacity;
  }
  .medium-zoom--opened .medium-zoom-overlay {
    cursor: zoom-out;
    opacity: 1;
    z-index: 999;
  }
  .medium-zoom-image {
    cursor: zoom-in;
    transition: transform 0.3s cubic-bezier(0.2, 0, 0.2, 1);
  }
  .medium-zoom-image--hidden {
    visibility: hidden;
  }
  .medium-zoom-image--opened {
    position: relative;
    cursor: zoom-out;
    will-change: transform;
    z-index: 999;
  }
</style>